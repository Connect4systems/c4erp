version: '3.8'

services:
  # MariaDB Database
  db:
    image: mariadb:10.6
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - db-data:/var/lib/mysql
      - ./config/mariadb/my.cnf:/etc/mysql/conf.d/my.cnf
    networks:
      - frappe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "--silent"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis Cache
  redis-cache:
    image: redis:7-alpine
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-cache-data:/data
    networks:
      - frappe-network
    restart: unless-stopped

  # Redis Queue
  redis-queue:
    image: redis:7-alpine
    volumes:
      - redis-queue-data:/data
    networks:
      - frappe-network
    restart: unless-stopped

  # Redis SocketIO
  redis-socketio:
    image: redis:7-alpine
    volumes:
      - redis-socketio-data:/data
    networks:
      - frappe-network
    restart: unless-stopped

  # Frappe/ERPNext Backend
  frappe:
    image: frappe/erpnext:${ERPNEXT_VERSION:-v15.0.0}
    command: bench serve --port 8000
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - REDIS_CACHE=${REDIS_CACHE}
      - REDIS_QUEUE=${REDIS_QUEUE}
      - REDIS_SOCKETIO=${REDIS_SOCKETIO}
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - assets:/home/frappe/frappe-bench/sites/assets
    networks:
      - frappe-network
    depends_on:
      - db
      - redis-cache
      - redis-queue
      - redis-socketio
    restart: unless-stopped
    ports:
      - "8000:8000"
    deploy:
      resources:
        limits:
          memory: ${WORKER_MEMORY_LIMIT:-2g}
          cpus: '${WORKER_CPU_LIMIT:-1.5}'

  # Frappe Worker (Background Jobs)
  frappe-worker:
    image: frappe/erpnext:${ERPNEXT_VERSION:-v15.0.0}
    command: bench worker --queue default,short,long
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - REDIS_CACHE=${REDIS_CACHE}
      - REDIS_QUEUE=${REDIS_QUEUE}
      - REDIS_SOCKETIO=${REDIS_SOCKETIO}
    volumes:
      - sites:/home/frappe/frappe-bench/sites
    networks:
      - frappe-network
    depends_on:
      - db
      - redis-cache
      - redis-queue
      - redis-socketio
    restart: unless-stopped
    deploy:
      replicas: 2

  # Frappe Scheduler
  frappe-scheduler:
    image: frappe/erpnext:${ERPNEXT_VERSION:-v15.0.0}
    command: bench schedule
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - REDIS_CACHE=${REDIS_CACHE}
      - REDIS_QUEUE=${REDIS_QUEUE}
      - REDIS_SOCKETIO=${REDIS_SOCKETIO}
    volumes:
      - sites:/home/frappe/frappe-bench/sites
    networks:
      - frappe-network
    depends_on:
      - db
      - redis-cache
      - redis-queue
      - redis-socketio
    restart: unless-stopped

  # SocketIO Server
  frappe-socketio:
    image: frappe/erpnext:${ERPNEXT_VERSION:-v15.0.0}
    command: node /home/frappe/frappe-bench/apps/frappe/socketio.js
    environment:
      - REDIS_SOCKETIO=${REDIS_SOCKETIO}
    volumes:
      - sites:/home/frappe/frappe-bench/sites
    networks:
      - frappe-network
    depends_on:
      - redis-socketio
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./config/nginx/conf.d:/etc/nginx/conf.d
      - sites:/home/frappe/frappe-bench/sites
      - assets:/home/frappe/frappe-bench/sites/assets:ro
      - ./certs:/etc/nginx/certs
      - ./logs/nginx:/var/log/nginx
    networks:
      - frappe-network
    depends_on:
      - frappe
      - frappe-socketio
    restart: unless-stopped

  # Tenant Management API
  api-server:
    build: ./api-server
    ports:
      - "${API_PORT:-8001}:8000"
    environment:
      - DB_HOST=${DB_HOST}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - API_SECRET_KEY=${API_SECRET_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - SITES_DIR=${SITES_DIR}
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - ./backups:/backups
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - frappe-network
    depends_on:
      - db
      - frappe
    restart: unless-stopped

  # Prometheus (Monitoring)
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - frappe-network
    restart: unless-stopped
    profiles:
      - monitoring

  # Grafana (Visualization)
  grafana:
    image: grafana/grafana:latest
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - frappe-network
    depends_on:
      - prometheus
    restart: unless-stopped
    profiles:
      - monitoring

  # Backup Service
  backup:
    build: ./backup-service
    environment:
      - BACKUP_DIR=${BACKUP_DIR}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS}
      - S3_BACKUP_ENABLED=${S3_BACKUP_ENABLED}
      - S3_BUCKET=${S3_BUCKET}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - sites:/home/frappe/frappe-bench/sites:ro
      - ./backups:/backups
    networks:
      - frappe-network
    depends_on:
      - db
    restart: unless-stopped

networks:
  frappe-network:
    driver: bridge

volumes:
  db-data:
  redis-cache-data:
  redis-queue-data:
  redis-socketio-data:
  sites:
  assets:
  prometheus-data:
  grafana-data:
