# Default Server Block - HTTP Only (Development)
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    root /home/frappe/frappe-bench/sites;

    # Rate Limiting
    limit_req zone=general burst=20 nodelay;

    # Static Assets
    location /assets {
        try_files $uri =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location /files {
        try_files /$host/public/$uri @frappe;
        expires 1y;
        add_header Cache-Control "public";
    }

    # SocketIO
    location /socket.io {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Frappe-Site-Name $host;
        proxy_set_header Origin $scheme://$http_host;
        proxy_set_header Host $host;
        proxy_pass http://socketio-server/socket.io;
    }

    # Login Rate Limiting
    location /api/method/login {
        limit_req zone=login burst=5 nodelay;
        include proxy_params;
        proxy_set_header X-Frappe-Site-Name $host;
        proxy_pass http://frappe-server;
    }

    # Frappe Application
    location @frappe {
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Frappe-Site-Name $host;
        proxy_set_header Host $host;
        proxy_set_header X-Use-X-Accel-Redirect True;
        proxy_read_timeout 120;
        proxy_redirect off;

        proxy_pass http://frappe-server;
    }

    location / {
        try_files /$host/public/$uri @frappe;
    }

    # Error Pages
    error_page 502 /502.html;
    location = /502.html {
        root /usr/share/nginx/html;
        internal;
    }
}

# HTTPS Configuration (Commented out - Enable when SSL certificates are available)
# Frappe Site Template
# Copy this block for each site and replace SITENAME
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name SITENAME;
#
#     # SSL Configuration
#     ssl_certificate /etc/nginx/certs/SITENAME/fullchain.pem;
#     ssl_certificate_key /etc/nginx/certs/SITENAME/privkey.pem;
#     ssl_session_timeout 1d;
#     ssl_session_cache shared:SSL:50m;
#     ssl_session_tickets off;
#
#     # Modern SSL Configuration
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
#     ssl_prefer_server_ciphers off;
#
#     # Security Headers
#     add_header Strict-Transport-Security "max-age=63072000" always;
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "no-referrer-when-downgrade" always;
#
#     root /home/frappe/frappe-bench/sites;
#
#     # Rate Limiting
#     limit_req zone=general burst=20 nodelay;
#
#     # Static Assets
#     location /assets {
#         try_files $uri =404;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#     }
#
#     location /files {
#         try_files /SITENAME/public/$uri @frappe;
#         expires 1y;
#         add_header Cache-Control "public";
#     }
#
#     # SocketIO
#     location /socket.io {
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_set_header X-Frappe-Site-Name SITENAME;
#         proxy_set_header Origin $scheme://$http_host;
#         proxy_set_header Host $host;
#         proxy_pass http://socketio-server/socket.io;
#     }
#
#     # Login Rate Limiting
#     location /api/method/login {
#         limit_req zone=login burst=5 nodelay;
#         proxy_pass http://frappe-server;
#         include proxy_params;
#     }
#
#     # Frappe Application
#     location @frappe {
#         proxy_http_version 1.1;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Frappe-Site-Name SITENAME;
#         proxy_set_header Host $host;
#         proxy_set_header X-Use-X-Accel-Redirect True;
#         proxy_read_timeout 120;
#         proxy_redirect off;
#
#         proxy_pass http://frappe-server;
#     }
#
#     location / {
#         try_files /SITENAME/public/$uri @frappe;
#     }
#
#     # Error Pages
#     error_page 502 /502.html;
#     location = /502.html {
#         root /usr/share/nginx/html;
#         internal;
#     }
# }
